# Phân tích mẫu malware Ramnit

## Cài đặt vào máy nạn nhân
Sau khi được nạn nhân tải về máy và thực thi thì malware tiến hành cài đặt mình vào máy nạn nhân:

- Drop file [tên file cũ]mrg.exe.
- Sử dụng *Microsoft Windows Kernel 'Win32k.sys' Local Privilege Escalation Vulnerability(CVE-2014-4113 )* để hoạt động ở quyền **Administrative**.
- Tiến hành hook vào **API ZwWriteVirtualMemory** và chạy tiến trình **IE** để thực hiện đoạn mã hook.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/6bd38de263816afd9fa98ad0217c1c4385f2421f/Images/setDebugPrivilege.png">

File **.dll** của malware được inject vào tiến trình của **IE** tạo các file:

- %ProgramFiles%\[fake name folder]\[fake name file].exe (example: %ProgramFiles%\tnsinjux\cthuxjel.exe).
- %APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\[fake name file].exe ( axample: %APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\cthuxjel.exe).

Tạo Registry để khởi động cùng hệ thống: 

- Subkey: *HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon*
- Value name: Userinit
- Data: [system folder]\userinit.exe,%ProgramFiles%\[fake name folder]\[fake name file].exe

Tạo 1 file ghi log cho quá trình kết nối giữa server điều khiển (C&C) và client:

- %CurrentFolder%\dmlconf.dat

### Các hành vi của malware

Sau khi thực hiện xong quá trình cài đặt bản thân malawer và đảm bảo hoạt đồng bình thưởng ở máy nạn nhân, malware thực hiện các hành vi của mình.

#### Lấy các thông tin của máy nạn nhân

Malware tiến hành là các thông tin từ máy nạn nhân như:
- VolumeSerialNumber
- VersionInformation.dwBuildNumber
- VersionInformation.dwMajorVersion
- VersionInformation.dwMinorVersion
- SystemInfo.anonymous_0
- SystemInfo.dwActiveProcessorMask
- SystemInfo.dwNumberOfProcessors
- SystemInfo.dwProcessorType
- vSystemInfo.wProcessorLevel
- SystemInfo.wProcessorRevision
- ComputerName

Sau đó dùng hàm hash MD5 để tính hash của các thông số nhận được để tạo thành chuỗi md5_1.
Tiếp tục cộng **45Bn99gT** với md5_1 sau đó tiếp tục dùng hàm hash MD5 để tạo thành chuỗi md5_2.
Sau đó gửi 2 chuỗi hash đã tạo được đến server điều khiển thông qua cổng **443**.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/ca10fe9168fd104a128695f9f3a373da38a1f804/Images/information_PC_1.PNG">

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/e27c6a22fe2a77680cea50ad6fb9bd1a7aadd188/Images/information_PC.PNG">

#### BackDoor

Malware mở cổng **443** và tiến hành vòng lặp nhận lệnh và thực hiện với server điều khiển.
Các chức năng của backdoor:

- **getexec**: Tải file từ máy chủ điều khiển và thực thi file tải về.
- **kos**: Xóa tất cả các Registry key **HKEY_LOCAL_MACHINE\SOFTWARE, HKEY_LOCAL_MACHINE\SYSTEM, HKEY_LOCAL_MACHINE\HARDWARE, và HKEY_CURRENT_USER\SOFTWAR** và khởi động lại máy nạn nhân.
- **screen**: chụp ảnh màng hình máy nạn nhâu rồi gửi về máy chủ điều khiển.
- **update**: tải file update từ URL nhận từ máy chủ điều khiển, thực thi file vừa tải và kết thúc tiến trình của malware hiện tại.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/f3833350e201417d277e8c9bdddf746b50a44bc8/Images/backdoor.PNG">

#### Lây nhiễm

Malware tiến hành kiển tra Registry key **KEY_LOCAL_MACHINE\SOFTWARE\WASAntidot** với giá trị là *disable*, nếu key tồn tại thì sẽ đưa ra 1 MessageBox với chuỗi **Antidot is activate** và kết thúc quá trình lấy nhiễm.

Trước khi thực hiện lây nhiễm thì malware tiến hành tạo một VB Script hardcode với thông số là tạo một file **svchost.exe** với nội dung là bản sao của malware và chạy file. Sau khi tạo xong Script thì malware tiến hành tạo 2 thread để tiến hành lây nhiễm trên **Disk** và **Removable Disk**.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/63bc63efe30eebd100035cdefeabd06448e2d578/Images/check_antidot.PNG">

##### Lây nhiễm trên Disk(đĩa cứng) trên máy nạn nhân

Malware sử dụng API **GetLogicalDriveStrings** để kiểm tra ỗ đĩa hợp lệ trên máy nhân và kiểm tra vung nhớ trống lớn hơn **0x80000(512KB)** thì tiến hành lây nhiễm.
Quét các file có trong ổ đĩa, kiểm tra nếu đuôi file là **exe,dll,scr** hay **html,htm** thì tiến hành lây nhiễm.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/c2d0f2d4c422b200e66d8e87c4d8b86e7b237456/Images/thread_2.PNG">

###### Lây nhiễm file exe,dll,scr

- Malware kiểm tra 0x24 byte từ offset được tính tại *FileSize - 0x24)*, sử dụng dword đầu tiên làm XOR key và sau đó lần lượt XOR với 0x24 byte và kiểm tra dword thứ 2 nếu là **0xFA1BC352** thì file đã bị lây nhiễm và kết thúc.
- Thêm 1 section và file với tên là **.text** sau đó copy bản sau của malware vào section, trỏ entry point tới section mới tạo(hình thức lây nhiễm của virus lây file), sau khi thực thi xong thì trả lại quyền điều khiển cho chương trình cũ.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/48b92a5af003c1bdb4c2fad05b96f697e254c064/Images/check_sig.PNG">

###### Lây nhiễm file html,htm

- Malware kiểm tra 0x24 byte từ offset được tính tại *FileSize - ( 3bytes + 0x24)*, sử dụng dword đầu tiên làm XOR key và sau đó lần lượt XOR với 0x24 byte và kiểm tra dword thứ 2 nếu là **0xFA1BC352** thì file đã bị lây nhiễm và kết thúc.
- Sau đó viết VBScript đã được tạo lúc đầu vào file

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/d936a0dd2f1db4784f54dbfb646c1166b1a1ba5d/Images/html.PNG">

##### Lây nhiễm trên ỗ đĩa di động

- Kiểm tra xem file **autorun.inf** đã chứa script lây nhiễm chưa, nếu rồi thì kết thúc.
- Tạo file **autorun.inf** và viết script lây nhiễm vào file vừa tạo.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/5656f879c0f045f9a27daef4d8484d93272d2a17/Images/removal.PNG">

#### Hành vi đặc trưng

- Kết nối tới server điều khiển: **stromoliks.com**, IP: **72.14.182.233**
- Cổng kết nối: **443**
- Giao thức giao tiếp: **TCP**

# Hàm diệt

## Kiểm tra máy tính có bị lây nhiễm

- Dựa vào các file, registry mà malware tạo để xác định máy có bị lây nhiễm không
- Nếu đã lây nhiễm tiến hành kill process bị lây nhiễm, xóa các file, registry mà malware đã tạo và sửa đổi

## Kiểm tra các file có bị lây nhiễm

- Dựa vào chữ ký của malware ở từng loại định dạng của file mà tiến hành kiểm tra chữ ký tương ứng (các loại định dạng bị lây nhiễm: exe, dll, src, html, htm)
- Nếu bị nhiễm thì thực hiện sửa chữa cho định dạng exe, dll, src, xóa script thực của malware cho định dạng html, htm.
