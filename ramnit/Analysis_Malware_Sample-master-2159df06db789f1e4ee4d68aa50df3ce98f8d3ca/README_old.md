<h2> Phân Tích Mẫu Malware Ramnit </h2>

**Cơ chế xâm nhập vào máy nạn nhân:**

- Nó đính mình vào các file khác để xâm nhập vào hệ thống

**Chi tiết các hành vi:**

**__Bước 1__**: Sau khi inject code vào 1 file 7z nó được phát tán và xâm nhập vào máy nạn nhân. Khi nạn nhân khởi động chương trình phần code virus sẻ thực thi trước,
sau khi hoàn thành công việc của nó thì phần code của chương trình 7z mới được tiếp tục chạy vì thế không gây nghi ngờ cho nạn nhân.

- Sau khi thực hiện các công việc như kiểm tra và load các thư viện cần thiết, nó tạo 1 chuỗi nhận dạng và kiểm tra bằng hàm `OpenMutexA` để kiểm tra xem có tiến trình
nào khác của nó đang được thực hiện, nếu có thì thoát khỏi code virus và trả về cho chương trình gốc.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/OpenMutexA.PNG">

- Tiếp tục, nó tạo một tên mới bằng cách cộng **tên file cũ** với **mgr.exe** và sử dụng hàm `CreateFile` để tạo file mới cùng thư mục và `WrietFile` để ghi vào file đoạn
code virus mới.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/30ff4ad74524bcac144ca73e5eea9c8ee09ddce6/Images/CreateFile_WriteFile.PNG"> 

- Tiếp tục, tạo process với file vừa tạo để chạy file vừa tạo bằng hàm `CreateProcessEx`

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/CreateProcess.PNG"> ;

- Sau đó trả lại quyền điều khiển cho chương trình gốc.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/return.png"> 

**__Bước 2__**: Tiến hành phân tích file nó mới tạo `7zmgr.exe`. File này cũng có cấu trúc như file ban đầu, sau khi kiểm tra duy nhất process của nó đang chạy thì nó trả
quyền lại cho chương trình gốc chính là chương trình virus mới.

- Kiểm tra xem Brower defaut có phải là IE không, nếu không phải thì tiến hành đặt IE là brower defaut của chương trình và trả về đường dẫn của IE.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/IE_Brower.PNG"> 

- Tiếp theo, tiến hành set **SeDebugPrivilege**, quyền cao nhất cho một tiến trình cho tiến trình của virus.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/setDebugPrivilege.png"> 

- Sau đó nó tiến hành hook vào hàm `ZwWriteVirtualMemory` của thư viện liên kết động `ntdll.dll` để thây đổi địa chỉ trong thư viện thành hàm của virus.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/hook_ZwWriteVirtualMemory.PNG">

- Sau đó nó tạo process và chạy chương trình IE(thực ra là chạy chương trình IE bị injected code virus).

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/Craete_Process_IE.PNG">

- Tiếp tục nó khôi phục lại địa chỉ ban đầu của hàm `ZwWriteVirualMemory` như ban đầu cho thư viện liên kết động `ntdll.dll`

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/restore_addr_zWwrite.PNG">

- Cuối nó dùng hàm `Sleep` để dừng chương trình và sau đó thoát.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/Sleep_exit.PNG">

**__Bước 3__**: Tiến hành phân tích hàm inject vào tiến trình IE.

- Tiến hành cấp phát 1 vùng nhớ trong process của IE sau đó ghi 1 file `.dll` vào vùng nhớ mới được cấp phát.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/alloc_write.PNG">

- Sau đó nó tiếp tục cấp phát và ghi 2 function vào vùng nhớ của IE. 2 vùng nhớ này có nhiệm vụ chỉnh sửa và nhảy tới code của vùng nhớ dll inject vào lúc trước.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/alloc_write_2_function.PNG">

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/2_function_to_write.PNG">

- Cuối nó sửa đổi quyền của vùng nhớ trong IE rồi ghi code vào vùng nhớ, sau đó chỉnh lại quyền của vùng nhớ về ban đầu.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9403508e9f284d17704b36ce81455eeff1a123b5/Images/code_to_write.PNG">

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/c86eca6667dd6db5d46e939b9a7c1216a0260dec/Images/write_go_code.PNG">

**__Bước 4__**: Tiến hành dump và phân tích file dll của virus.

- Dùng OllyDBG để attach vào tiến trình `IEXPLORE.EXE` mà virus đã inject vào, ta di chuyển tới vùng nhớ mà virus đã khởi tạo và viết vào (vùng nhớ 0x20010000).
Dấu hiệu nhận biết, ta thấy có 2 byte đầu là `20010000  4D 5A ` đây là DOSHEADER của 1 file PE.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/7988490384b1d23f1e0ca99a683fb6e7c1d8c834/Images/dump_dll.PNG">

- Tiến hành dump ra và kiểm tra với CFF Explore, đây là 1 file dll.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/ceb8dc5efdb1d4b06794c6f21912f6dd529e13f8/Images/CFF_explore.PNG">

- Tiến hành phân tích hành vi của file dll vừa dump được, nó tiến hành kiểm tra xem nếu có tiến trình nào của virus đang chạy thì nó sẽ thoát.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/100b9cb6f5f2dd5bb0760083851ed713b94b3481/Images/check_Mutex.PNG">

- Virus dùng 2 APIs là `GetWindowsDirectoryA`, `GetVolumeInformationA` và các tham số đầu vào do virus định sẵn để tạo ra 1 fake name.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/9193efa779e8be465bc53d2bda234fbd75cfadcf/Images/fake_name_1.PNG">

- Sau đó nó mở registry key `Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders` để lấy đường dẫn chứa các file startup. Sau đó tiến hành tạo 1 bản sao
code virus vs fake name ở đường dẫn startup.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/c4c3647b3e28a978ea5cd52689586bb313d0d8a6/Images/and_startup.PNG">

- Sử dụng API `GetSystemTimeAsFileTime` để lấy thời gian của hệ thống sau đó ghi ra file `dmlconf.dat` trong thư mục IE.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/2b2b7ab3cb3118903f759032166c3af81b73d9e8/Images/check_systime.PNG">

- virus tiếp tục tạo ra 2 fake name, 1 là tên file, 1 là tên folder. Và kiểm tra xem key registry winlogon đã được tạo chưa.

- Nếu chưa tạo key winlogon, sẽ kiểm tra xem các khu vực nào trong máy nạn nhân được phép tạo thư mục và file. Sau đó tiến hành tạo file và thư mục

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/7d67687e93839dbf1b842d78c5568a7d724c6d06/Images/check_write.PNG">

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/b836d5f582d00710636fd32085f53cea72d58b33/Images/create_check.PNG">

- Sau đó tạo bản sau code virus vào file mới được tạo, tiếp tục gọi 1 process để ghi key winlogon để khởi động cùng windows.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/f8ff6e7592373a73522dd259790b67b24b3c77d1/Images/write_file.PNG">

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/4de5fc0bf742cbcbac82580a3022395e3ae4b901/Images/write_registry.PNG">

- Sau khi hoàn thành các bước để lây nhiễm và tái khởi động khi nạn nhân tắt/bật máy. Virus tiến hành khởi chạy 4 thread độc lập.
- Thread đầu tiên là sử dụng socket để kiểm tra kết nối tới google và sleep.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/1ee16c1a22eed2444937731734a229bcbe94e8ba/Images/check_connect_google.PNG">

- Thread tiếp theo là ghi log của virus với thời gian lấy từ hệ thống vào file log `dmlconf.dat` mà đã tạo trước đó.

<img src="https://gitlab.visc.com/tinhpt3/Analysis_Malware_Sample/raw/fe301608444c4e4dea989142b25b1d4f1a9e1969/Images/write_log.PNG">

- 2 thread còn lại là việc khởi tạo các kết nối tới server điều kiển (C&C) của virus, xác định các thông tin xác thực của virus. Sau đó tải lên các thông tin
của máy nạn nhân như computername, username, SystemBiosVersion, ProductId được hash bằng thuật toán md5 để làm mã nhận diện cho máy của nạn nhân.
- Tiếp tục tải về các thông tin cần thiết để bổ xung vào các script đã được hardcode trong virus( do server đã chết việc tiến hành phân tích việc tải lên và tải
về những gì rất khó khăn nên không tiếp tục phân tích chi tiết)
- Kết hợp phân tích code và sandbox ta nhận biết các đặc điểm kết nối sau: Máy chủ điều khiển(C&C): `Stromoliks.com`, IP:`72.14.182.233` , phương thức kết nối: `TCP`, port `443`

**__Bước 5__**: Viết chương trình diệt virus.

- Dựa vào quá trình phân tích, nhận thấy rằng nếu máy bị nhiễm thì sẽ có những file với tên là fake name tạo ra từ các thông tin máy tính và thông số hardcode
dựa trên đoạn mã tính toán của virus. Từ đó, dùng đoạn mã của virus để tạo fake name cho máy cần kiểm tra, kiểm tra xem file có tồn tại không. Sau đó tiến hành
xóa các file, folder, registry do virus tạo ra. Kill tiến trình IE 


