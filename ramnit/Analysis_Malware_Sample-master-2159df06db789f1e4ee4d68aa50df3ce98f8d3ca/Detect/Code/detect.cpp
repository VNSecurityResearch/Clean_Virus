#include<stdio.h>
#include<Windows.h>
#include <process.h>
#include<TlHelp32.h>

void Create_fake_name_file(char *fake_name_file);
void Create_fake_name_folder(char *fake_name_folder);
void get_path_startup(char *path_file);
int check_file(char *path, char *fake_name_file);
void Del_virus(char *fake_name_file, char *fake_name_folder);
void KillProcessVirus();
void Kill();
void Kill_1(char *file_name);
void Kill_2(char *file_name);
void Search_file(char *path);

int main()
{
	char fake_name_file[15] = { 0 };
	char fake_name_folder[9] = { 0 };
	char path_file[255] = { 0 };
	char path_folder[255] = "C:\\Program Files\\";
	// tao fake name file va fake name folder tren may tinh bang thuat toan cua malware
	Create_fake_name_file(fake_name_file);
	Create_fake_name_folder(fake_name_folder);
	// lay duong dan thu muc startup
	get_path_startup(path_file);
	strcat(path_folder, fake_name_folder);
	// kiem tra cac file do malware tao co ton tai khong, neu co tien hanh cac ham diet
	if (check_file(path_file, fake_name_file) == 1 && check_file(path_folder, fake_name_file) == 1)
	{
		printf("[+] Deteted\n");
		printf("[+] Clear Virus...\n");
		strcat(path_file, "\\");
		strcat(path_file, fake_name_file);
		strcat(path_folder, "\\");
		strcat(path_folder, fake_name_file);
		// Kill process bi lay nhiem
		// xoa cac file do malware tao
		// Sua lai Regitry key value do malware sua doi
		Del_virus(path_file, path_folder);
		printf("Do you want scan your disk?(Y/N)");
		if (getchar() == 'Y' || getchar() == 'y')
		{
			// quet cac file trong duong dan cho nguoi dung chi dinh de kiem tra malware
			Kill();
		}
	}
	else
	{
		printf("[+] Your PC isn't infected");
	}

	return 0;
}
// tao fake nam file theo thuat toan cua malware
void Create_fake_name_file(char *fake_name_file)
{
	int dir, i;
	char Buffer[256] = { 0 };
	char name[15] = { 0 };
	DWORD VolumeSerialNumber;
	dir = GetWindowsDirectoryA(Buffer, 0x104);
	for (i = 0; i < strlen(Buffer); i++)
	{
		if (Buffer[i] == ':')
		{
			Buffer[i + 1] = '\\';
			Buffer[i + 2] = '\0';
			break;
		}
	}
	GetVolumeInformationA(Buffer, 0, 0, &VolumeSerialNumber, 0, 0, 0, 0);
	for (i = 0; i < 8; i++)
	{
		VolumeSerialNumber += 0x911;
		VolumeSerialNumber = (16807 * (VolumeSerialNumber % 0x1F31D) - 2836 * (VolumeSerialNumber / 0x1F31D));
		name[i] = (char)((VolumeSerialNumber % 0x19) + 97);
	}
	strcat(name, ".exe");
	strcpy(fake_name_file, name);
}
// tao fake name folder theo thuat toan cua malware
void Create_fake_name_folder(char *fake_name_folder)
{
	int dir, i;
	CHAR Buffer[256] = { 0 };
	CHAR name[9] = { 0 };
	DWORD VolumeSerialNumber;
	dir = GetWindowsDirectoryA(Buffer, 0x104);
	for (i = 0; i < strlen(Buffer); i++)
	{
		if (Buffer[i] == ':')
		{
			Buffer[i + 1] = '\\';
			Buffer[i + 2] = '\0';
			break;
		}
	}
	GetVolumeInformationA(Buffer, 0, 0, &VolumeSerialNumber, 0, 0, 0, 0);
	for (i = 0; i < 8; i++)
	{
		VolumeSerialNumber += 0x1a79;
		VolumeSerialNumber = (16807 * (VolumeSerialNumber % 0x1F31D) - 2836 * (VolumeSerialNumber / 0x1F31D));
		name[i] = (char)((VolumeSerialNumber % 0x19) + 97);
	}
	strcpy(fake_name_folder, name);
}
// lay duong dan cua thu muc startup
void get_path_startup(char *path_file)
{
	char name1[65] = "Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders";
	char name2[8] = "Startup";
	char path[256] = { 0 };
	DWORD cbData;
	HKEY phkResult;

	if (!RegOpenKeyExA(HKEY_CURRENT_USER, name1, 0, 1, &phkResult))
	{
		cbData = 0;
		if (!RegQueryValueExA(phkResult, name2, 0, 0, 0, &cbData))
		{
			if (!RegQueryValueExA(phkResult, name2, 0, 0, (BYTE*)path, &cbData))
			{
				strcpy(path_file, path);
			}
		}
	}
}
// kiem tra cac file neu malware da lay nhiem
int check_file(CHAR *path, char *fake_name_file)
{
	WIN32_FIND_DATAA FindFileData;
	HANDLE hFind;
	SetCurrentDirectoryA(path);
	hFind = FindFirstFileA("*.exe", &FindFileData);
	int result = 0;
	if (hFind != INVALID_HANDLE_VALUE)
	{
		do {
			if (!(FindFileData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY))
			{
				if (strcmp(fake_name_file, &FindFileData.cFileName) == 0)
				{
					result = 1;
				}
			}
		} while (FindNextFileA(hFind, &FindFileData));
	}
	return result;
}
// Kill process bi malware lay nhiem (IE)
void KillProcessVirus()
{
	HANDLE hSnapShot = CreateToolhelp32Snapshot(TH32CS_SNAPALL, NULL);
	PROCESSENTRY32 pEntry;
	pEntry.dwSize = sizeof(pEntry);
	BOOL hRes = Process32First(hSnapShot, &pEntry);
	while (hRes)
	{
		if (strcmp((const char *)pEntry.szExeFile, (const char *)L"IEXPLORE.EXE") == 0 || strcmp((const char *)pEntry.szExeFile, (const char *)L"iexplore.exe") == 0)
		{
			HANDLE hProcess = OpenProcess(PROCESS_TERMINATE, 0,
				(DWORD)pEntry.th32ProcessID);
			if (hProcess != NULL)
			{
				TerminateProcess(hProcess, 9);
				CloseHandle(hProcess);
			}
		}
		hRes = Process32Next(hSnapShot, &pEntry);
	}
	CloseHandle(hSnapShot);
}
// Ham diet 
void Del_virus(char *fake_name_file, char *fake_name_folder)
{
	// Kill Process
	KillProcessVirus();
	// Delete file
	DeleteFileA(fake_name_file);
	DeleteFileA(fake_name_folder);
	// Sua lai registry key
	HKEY phkResult;
	BYTE *lpData;
	DWORD dwDisposition;
	DWORD open = RegCreateKeyExA(HKEY_LOCAL_MACHINE, "Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon", 0, "REG_SZ", 0, 0xF003F, 0, &phkResult, &dwDisposition);
	lpData = (BYTE *)GlobalAlloc(0x40u, dwDisposition);
	memcpy(lpData, "C:\\Windows\\system32\\userinit.exe,", 32);
	DWORD value = RegSetValueExA(phkResult, "Userinit", 0, 1, (const BYTE *)lpData, 32);

}
//nhan duong dan do nguoi dung nhap vao
void Kill()
{

	char path[255];
	printf("Input path: ");
	fgets(path, 255, stdin);
	path[strlen(path) - 1] = '\0';
	Search_file(path);
	printf("\nDone!");
}
void Search_file(char *path)
{
	WIN32_FIND_DATAA FindFileData;
	HANDLE hFind;
	SetCurrentDirectoryA(path);
	hFind = FindFirstFileA("*.*", &FindFileData);
	if (hFind != INVALID_HANDLE_VALUE)
	{
		do {
			if (!(FindFileData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY))
			{
				if (strrchr(FindFileData.cFileName, '.') != NULL)
				{
					// kiem tra cac file bi lay nhiem co phan mo rong la exe, dll, src, html, htm
					if (!strcmp(strrchr(FindFileData.cFileName, '.'), ".exe") || !strcmp(strrchr(FindFileData.cFileName, '.'), ".dll") || !strcmp(strrchr(FindFileData.cFileName, '.'), ".scr"))
					{
						Kill_1(FindFileData.cFileName);
					}
					if (!strcmp(strrchr(FindFileData.cFileName, '.'), ".html") || !strcmp(strrchr(FindFileData.cFileName, '.'), ".htm"))
					{
						Kill_2(FindFileData.cFileName);
					}
				}
			}
			else
			{
				if (strcmp(FindFileData.cFileName, ".") != 0 && strcmp(FindFileData.cFileName, "..") != 0 && FindFileData.cFileName != '$')
				{
					Search_file(FindFileData.cFileName);
					SetCurrentDirectoryA("..");
				}
			}
		} while (FindNextFileA(hFind, &FindFileData));
	}
}
// Kiem tra cac file co phan mo rong la exe, dll, src
void Kill_1(char *file_name)
{
	HANDLE hFile;
	DWORD NumberOfBytesRead;
	DWORD FileSizeHigh, filesize, OEP;
	hFile = CreateFileA(file_name, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, 0, OPEN_EXISTING, FILE_ATTRIBUTE_ARCHIVE, 0);
	if (hFile != NULL)
	{
		filesize = GetFileSize(hFile, &FileSizeHigh);
		if (filesize > 0x24 && filesize != -1 && !FileSizeHigh)
		{
			// doc 24byte cuoi cung de kiem tra chu ky malware
			SetFilePointer(hFile, filesize - 0x24, 0, 0);
			CHAR Buffer[0x25] = { 0 };
			if (ReadFile(hFile, Buffer, 0x24u, &NumberOfBytesRead, 0))
			{
				// XOR de tim chu ky
				DWORD i,temp;
				memcpy(&i, Buffer, 4);
				memcpy(&temp, (Buffer + 4), 4);
				temp ^= i;
				if (temp == 0xFA1BC352)
				{
					// Co chu ky -> file da bi lay nhiem tien hanh khoi phuc
					HANDLE hMapping = CreateFileMappingA(hFile, NULL, PAGE_READWRITE, 0, 0, 0);
					if (hMapping != NULL)
					{
						char* pMapping = (char*)MapViewOfFile(hMapping, FILE_MAP_READ | FILE_MAP_WRITE, 0, 0, 0);
						PIMAGE_DOS_HEADER dos_header = (PIMAGE_DOS_HEADER)pMapping;
						if (dos_header->e_magic == IMAGE_DOS_SIGNATURE)
						{
							PIMAGE_NT_HEADERS header = (PIMAGE_NT_HEADERS)(pMapping + dos_header->e_lfanew);
							if (header->Signature == IMAGE_NT_SIGNATURE)
							{
								// xoa section cua malware
								// sua lai entry point
								// sizeofimages
								// -> file duoc sua xong chay binh thuong
								WORD numsec = header->FileHeader.NumberOfSections - 1;
								header->FileHeader.NumberOfSections = numsec;
								PIMAGE_SECTION_HEADER Final_Section = (PIMAGE_SECTION_HEADER)(pMapping + dos_header->e_lfanew + sizeof(IMAGE_NT_HEADERS) + numsec * sizeof(IMAGE_SECTION_HEADER));
								header->OptionalHeader.SizeOfImage = header->OptionalHeader.SizeOfImage - Final_Section->Misc.VirtualSize;
								memcpy(&OEP, (pMapping + Final_Section->PointerToRawData + 0x771), 4);
								DWORD newOEP = header->OptionalHeader.AddressOfEntryPoint - OEP;
								header->OptionalHeader.AddressOfEntryPoint = newOEP;
								memset((pMapping + Final_Section->PointerToRawData), 0, Final_Section->SizeOfRawData + 0x300);
								Final_Section->Characteristics = 0x00000000;
								Final_Section->Misc.PhysicalAddress = 0x00000000;
								Final_Section->Misc.VirtualSize = 0x00000000;
								memset(&Final_Section->Name, 0, 5);
								Final_Section->NumberOfLinenumbers = 0x0000;
								Final_Section->NumberOfRelocations = 0x0000;
								Final_Section->PointerToLinenumbers = 0x00000000;
								Final_Section->PointerToRawData = 0x00000000;
								Final_Section->PointerToRelocations = 0x00000000;
								Final_Section->SizeOfRawData = 0x00000000;
								Final_Section->VirtualAddress = 0x00000000;
								UnmapViewOfFile(pMapping);
								CloseHandle(hMapping);
								CloseHandle(hFile);
								printf("[+] Repair file %s complete\n", file_name);
							}
						}
					}
				}
				else
				{
					CloseHandle(hFile);
				}
			}
		}
	}
}
// kiem tra lay nhiem voi phan mo rong html, htm
void Kill_2(char *file_name)
{
	HANDLE hFile, hMap;
	DWORD NumberOfBytesRead;
	DWORD FileSizeHigh, filesize, OEP;
	CHAR Buffer[0x25] = { 0 };
	hFile = CreateFileA(file_name, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, 0, OPEN_EXISTING, FILE_ATTRIBUTE_ARCHIVE, 0);
	if (hFile != NULL)
	{
		filesize = GetFileSize(hFile, &FileSizeHigh);
		if (filesize > 0x24 && filesize != -1 && !FileSizeHigh)
		{
			// doc 24byte tai vi tri filesize - 0x27 de kiem tra chu ky malware
			SetFilePointer(hFile, filesize - 0x27, 0, 0);
			if (ReadFile(hFile, Buffer, 0x24u, &NumberOfBytesRead, 0))
			{
				// XOR de lay chu ky ( neu co)
				DWORD i, temp;
				memcpy(&i, Buffer, 4);
				memcpy(&temp, (Buffer + 4), 4);
				temp ^= i;
				if (temp == 0xFA1BC352)
				{
					// Chu ky hop le -> file da bi lay nhiem
					HANDLE hMapping = CreateFileMappingA(hFile, NULL, PAGE_READWRITE, 0, 0, 0);
					if (hMapping != NULL)
					{
						char* pMapping = (char*)MapViewOfFile(hMapping, FILE_MAP_READ | FILE_MAP_WRITE, 0, 0, 0);
						for (i = 0; i < filesize; i++)
						{
							if (!memcmp(pMapping + i, "<SCRIPT Language=VBScript>", 26))
							{
								// xoa phan lay nhiem cua malware
								DWORD len = filesize - i;
								memset((pMapping + i), 0, len);
							}
						}
						UnmapViewOfFile(pMapping);
						CloseHandle(hMapping);
						CloseHandle(hFile);
						printf("[+] Repair file %s complete\n", file_name);
					}
				}
				else
				{
					CloseHandle(hFile);
				}
			}
		}
	}
}